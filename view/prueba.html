<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Reportes de Asistencia</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .loading i {
            font-size: 3rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            padding: 30px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card i {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .stat-card .number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .report-item {
            background: #f8f9fa;
            border-left: 5px solid #667eea;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 0 8px 8px 0;
        }

        .report-item.ausente {
            border-left-color: #dc3545;
        }

        .report-item.tardanza {
            border-left-color: #ffc107;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .report-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #495057;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-presente {
            background: #d4edda;
            color: #155724;
        }

        .status-ausente {
            background: #f8d7da;
            color: #721c24;
        }

        .report-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-item i {
            color: #667eea;
            width: 20px;
        }

        .observations {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .observations ul {
            list-style: none;
            margin: 0;
        }

        .observations li {
            padding: 2px 0;
        }

        .observations li:before {
            content: "⚠️ ";
            margin-right: 5px;
        }

        .export-buttons {
            margin-top: 20px;
            text-align: center;
        }

        .btn-secondary {
            background: #6c757d;
            margin: 0 10px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: 1fr 1fr;
            }
            
            .report-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> Reportes de Asistencia</h1>
            <p>Sistema Integral de Control de Asistencias</p>
        </div>

        <div class="controls">
            <div class="form-row">
                <div class="form-group">
                    <label for="fechaInicio">
                        <i class="fas fa-calendar-alt"></i> Fecha Inicio
                    </label>
                    <input type="date" id="fechaInicio" required>
                </div>
                <div class="form-group">
                    <label for="fechaFin">
                        <i class="fas fa-calendar-alt"></i> Fecha Fin
                    </label>
                    <input type="date" id="fechaFin" required>
                </div>
                <div class="form-group">
                    <label for="numeroCuenta">
                        <i class="fas fa-user"></i> Número de Cuenta (Opcional)
                    </label>
                    <input type="text" id="numeroCuenta" placeholder="Ej: 314302498,317167283">
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="generarReporte()" id="btnGenerar">
                    <i class="fas fa-chart-bar"></i> Generar Reporte
                </button>
            </div>
        </div>

        <div class="loading" id="loading">
            <i class="fas fa-spinner"></i>
            <p>Generando reporte...</p>
        </div>

        <div class="results" id="results" style="display: none;">
            <div class="stats" id="stats"></div>
            <div class="export-buttons">
                <button class="btn btn-secondary" onclick="exportarCSV()">
                    <i class="fas fa-file-csv"></i> Exportar CSV
                </button>
                <button class="btn btn-secondary" onclick="exportarPDF()">
                    <i class="fas fa-file-pdf"></i> Exportar PDF
                </button>
            </div>
            <div id="reporteDetalle"></div>
        </div>
    </div>

    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>

    <!-- Tu configuración de Firebase -->
    <script src="firebase-config.js"></script>

    <script>
        // Generador de Reportes de Asistencia
        class GeneradorReporteAsistencia {
            constructor(db) {
                this.db = db;
                this.reporteActual = null;
            }

            horaAMinutos(horaStr) {
                if (!horaStr) return 0;
                const [hora, minuto] = horaStr.split(':').map(Number);
                return hora * 60 + minuto;
            }

            minutosAHora(minutos) {
                const horas = Math.floor(minutos / 60);
                const mins = minutos % 60;
                return `${horas.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
            }

            obtenerNombreDia(fecha) {
                const dias = ['domingo', 'lunes', 'martes', 'miércoles', 'jueves', 'viernes', 'sábado'];
                return dias[fecha.getDay()];
            }

            calcularDiferenciaTiempo(horaReal, horaOficial) {
                const minutosReal = this.horaAMinutos(horaReal);
                const minutosOficial = this.horaAMinutos(horaOficial);
                return minutosReal - minutosOficial;
            }

            async generarReporte(fechaInicio, fechaFin, numerosCuenta = null) {
                try {
                    const reporte = [];

                    // 1. Obtener configuración
                    const configSnapshot = await this.db.collection('configuracion').get();
                    const configuraciones = {};
                    configSnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.tipoBloque) {
                            configuraciones[doc.id] = data;
                        }
                    });

                    // 2. Obtener horarios
                    let horariosQuery = this.db.collection('horarios');
                    if (numerosCuenta && numerosCuenta.length > 0) {
                        horariosQuery = horariosQuery.where('numeroCuenta', 'in', numerosCuenta);
                    }
                    
                    const horariosSnapshot = await horariosQuery.get();
                    const horarios = {};
                    
                    horariosSnapshot.forEach(doc => {
                        const data = doc.data();
                        const numeroCuenta = data.numeroCuenta;
                        
                        if (!horarios[numeroCuenta]) {
                            horarios[numeroCuenta] = [];
                        }
                        horarios[numeroCuenta].push({
                            id: doc.id,
                            ...data
                        });
                    });

                    // 3. Obtener asistencias
                    let asistenciasQuery = this.db.collection('asistenciasemana')
                        .where('fechaCompleta', '>=', fechaInicio)
                        .where('fechaCompleta', '<=', fechaFin);
                        
                    if (numerosCuenta && numerosCuenta.length > 0) {
                        asistenciasQuery = asistenciasQuery.where('numeroCuenta', 'in', numerosCuenta);
                    }

                    const asistenciasSnapshot = await asistenciasQuery.get();
                    const asistencias = {};

                    asistenciasSnapshot.forEach(doc => {
                        const data = doc.data();
                        const numeroCuenta = data.numeroCuenta;
                        const fecha = data.fechaCompleta.toDate();
                        const fechaStr = fecha.toISOString().split('T')[0];
                        
                        if (!asistencias[numeroCuenta]) {
                            asistencias[numeroCuenta] = {};
                        }
                        if (!asistencias[numeroCuenta][fechaStr]) {
                            asistencias[numeroCuenta][fechaStr] = [];
                        }
                        asistencias[numeroCuenta][fechaStr].push({
                            id: doc.id,
                            ...data,
                            fecha: fecha
                        });
                    });

                    // 4. Generar reporte
                    for (const numeroCuenta in horarios) {
                        const horariosPersona = horarios[numeroCuenta];
                        const asistenciasPersona = asistencias[numeroCuenta] || {};

                        const nombreAsesor = horariosPersona[0]?.nombreAsesor || 
                                           Object.values(asistenciasPersona)[0]?.[0]?.nombreAsesor || 
                                           'Nombre no encontrado';

                        let fechaActual = new Date(fechaInicio);
                        while (fechaActual <= fechaFin) {
                            const fechaStr = fechaActual.toISOString().split('T')[0];
                            const nombreDia = this.obtenerNombreDia(fechaActual);
                            
                            const horariosDelDia = horariosPersona.filter(horario => {
                                return horario.dias && horario.dias.includes(nombreDia);
                            });

                            if (horariosDelDia.length > 0) {
                                const asistenciaDelDia = asistenciasPersona[fechaStr] || [];

                                for (const horario of horariosDelDia) {
                                    const tipoBloque = horario.tipoBloque;

                                    const reporteItem = {
                                        numeroCuenta: numeroCuenta,
                                        nombreAsesor: nombreAsesor,
                                        fecha: fechaActual.toLocaleDateString('es-ES'),
                                        dia: nombreDia.charAt(0).toUpperCase() + nombreDia.slice(1),
                                        tipoBloque: tipoBloque,
                                        horarioOficial: {
                                            inicio: horario.horaInicio,
                                            fin: horario.horaFinal,
                                            horas: horario.horas
                                        },
                                        asistenciaReal: null,
                                        estado: 'AUSENTE',
                                        observaciones: [],
                                        tiempoTardanza: 0,
                                        tiempoSalidaTemprana: 0,
                                        horasTrabajadas: 0
                                    };

                                    if (asistenciaDelDia.length > 0) {
                                        let mejorCoincidencia = null;
                                        let menorDiferencia = Infinity;

                                        for (const asistencia of asistenciaDelDia) {
                                            if (asistencia.entrada && asistencia.entrada.horaOriginal) {
                                                const horaEntrada = asistencia.entrada.horaOriginal;
                                                const diferencia = Math.abs(
                                                    this.calcularDiferenciaTiempo(horaEntrada, horario.horaInicio)
                                                );
                                                
                                                if (diferencia < menorDiferencia) {
                                                    menorDiferencia = diferencia;
                                                    mejorCoincidencia = asistencia;
                                                }
                                            }
                                        }

                                        if (mejorCoincidencia) {
                                            const asistencia = mejorCoincidencia;
                                            reporteItem.estado = 'PRESENTE';
                                            
                                            reporteItem.asistenciaReal = {
                                                entrada: asistencia.entrada?.horaOriginal || null,
                                                salida: asistencia.salida?.horaOriginal || null,
                                                horasTrabajadas: asistencia.horasTrabajadas || '0h 0m'
                                            };

                                            if (asistencia.entrada?.horaOriginal) {
                                                const tardanza = this.calcularDiferenciaTiempo(
                                                    asistencia.entrada.horaOriginal,
                                                    horario.horaInicio
                                                );
                                                
                                                if (tardanza > 0) {
                                                    reporteItem.tiempoTardanza = tardanza;
                                                    reporteItem.observaciones.push(
                                                        `Llegó ${tardanza} minutos tarde`
                                                    );
                                                }
                                            }

                                            if (asistencia.salida?.horaOriginal) {
                                                const salidaTemprana = this.calcularDiferenciaTiempo(
                                                    horario.horaFinal,
                                                    asistencia.salida.horaOriginal
                                                );
                                                
                                                if (salidaTemprana > 0) {
                                                    reporteItem.tiempoSalidaTemprana = salidaTemprana;
                                                    reporteItem.observaciones.push(
                                                        `Salió ${salidaTemprana} minutos antes`
                                                    );
                                                }
                                            }

                                            if (asistencia.horasTrabajadas) {
                                                const match = asistencia.horasTrabajadas.match(/(\d+)h\s*(\d+)m/);
                                                if (match) {
                                                    const horas = parseInt(match[1]);
                                                    const minutos = parseInt(match[2]);
                                                    reporteItem.horasTrabajadas = horas * 60 + minutos;
                                                }
                                            }
                                        }
                                    }

                                    if (reporteItem.estado === 'AUSENTE') {
                                        reporteItem.observaciones.push('No registró asistencia');
                                    }

                                    reporte.push(reporteItem);
                                }
                            }

                            fechaActual.setDate(fechaActual.getDate() + 1);
                        }
                    }

                    this.reporteActual = reporte;
                    return reporte;

                } catch (error) {
                    console.error('Error generando reporte:', error);
                    throw error;
                }
            }

            obtenerEstadisticas(reporte) {
                const stats = {
                    totalRegistros: reporte.length,
                    presentes: 0,
                    ausentes: 0,
                    tardanzas: 0,
                    salidasTempranas: 0,
                    tiempoTotalTardanza: 0,
                    tiempoTotalSalidaTemprana: 0,
                    promedioHorasTrabajadas: 0
                };

                let totalMinutosTrabajados = 0;

                reporte.forEach(item => {
                    if (item.estado === 'PRESENTE') {
                        stats.presentes++;
                        totalMinutosTrabajados += item.horasTrabajadas;
                    } else {
                        stats.ausentes++;
                    }

                    if (item.tiempoTardanza > 0) {
                        stats.tardanzas++;
                        stats.tiempoTotalTardanza += item.tiempoTardanza;
                    }

                    if (item.tiempoSalidaTemprana > 0) {
                        stats.salidasTempranas++;
                        stats.tiempoTotalSalidaTemprana += item.tiempoSalidaTemprana;
                    }
                });

                if (stats.presentes > 0) {
                    stats.promedioHorasTrabajadas = Math.round(totalMinutosTrabajados / stats.presentes);
                }

                return stats;
            }
        }

        // Instancia global del generador
        const generador = new GeneradorReporteAsistencia(window.firebaseDB);

        // Funciones de la interfaz
        async function generarReporte() {
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            const numeroCuentaInput = document.getElementById('numeroCuenta').value;

            if (!fechaInicio || !fechaFin) {
                alert('Por favor selecciona las fechas de inicio y fin');
                return;
            }

            const numerosCuenta = numeroCuentaInput 
                ? numeroCuentaInput.split(',').map(n => n.trim()).filter(n => n)
                : null;

            // Mostrar loading
            document.getElementById('btnGenerar').disabled = true;
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';

            try {
                const fechaInicioObj = new Date(fechaInicio);
                const fechaFinObj = new Date(fechaFin);

                const reporte = await generador.generarReporte(fechaInicioObj, fechaFinObj, numerosCuenta);
                const estadisticas = generador.obtenerEstadisticas(reporte);

                mostrarResultados(reporte, estadisticas);

            } catch (error) {
                console.error('Error:', error);
                alert('Error al generar el reporte: ' + error.message);
            } finally {
                document.getElementById('btnGenerar').disabled = false;
                document.getElementById('loading').style.display = 'none';
            }
        }

        function mostrarResultados(reporte, estadisticas) {
            // Mostrar estadísticas
            const statsContainer = document.getElementById('stats');
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <i class="fas fa-clipboard-list"></i>
                    <div class="number">${estadisticas.totalRegistros}</div>
                    <div class="label">Total Registros</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-user-check"></i>
                    <div class="number">${estadisticas.presentes}</div>
                    <div class="label">Presentes</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-user-times"></i>
                    <div class="number">${estadisticas.ausentes}</div>
                    <div class="label">Ausentes</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-clock"></i>
                    <div class="number">${estadisticas.tardanzas}</div>
                    <div class="label">Tardanzas</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-hourglass-half"></i>
                    <div class="number">${generador.minutosAHora(estadisticas.promedioHorasTrabajadas)}</div>
                    <div class="label">Promedio Horas</div>
                </div>
            `;

            // Mostrar reporte detallado
            const reporteContainer = document.getElementById('reporteDetalle');
            reporteContainer.innerHTML = reporte.map(item => {
                const claseItem = item.estado === 'AUSENTE' ? 'ausente' : 
                                 (item.tiempoTardanza > 0 ? 'tardanza' : '');
                
                return `
                    <div class="report-item ${claseItem}">
                        <div class="report-header">
                            <div class="report-title">
                                ${item.nombreAsesor} (${item.numeroCuenta})
                            </div>
                            <div class="status-badge status-${item.estado.toLowerCase()}">
                                ${item.estado}
                            </div>
                        </div>
                        <div class="report-details">
                            <div class="detail-item">
                                <i class="fas fa-calendar"></i>
                                <span>${item.fecha} - ${item.dia}</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-clock"></i>
                                <span>Horario: ${item.horarioOficial.inicio} - ${item.horarioOficial.fin}</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-tag"></i>
                                <span>Tipo: ${item.tipoBloque}</span>
                            </div>
                            ${item.asistenciaReal ? `
                                <div class="detail-item">
                                    <i class="fas fa-sign-in-alt"></i>
                                    <span>Entrada: ${item.asistenciaReal.entrada || 'No registrada'}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span>Salida: ${item.asistenciaReal.salida || 'No registrada'}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-stopwatch"></i>
                                    <span>Trabajadas: ${generador.minutosAHora(item.horasTrabajadas)}</span>
                                </div>
                            ` : ''}
                        </div>
                        ${item.observaciones.length > 0 ? `
                            <div class="observations">
                                <ul>
                                    ${item.observaciones.map(obs => `<li>${obs}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            document.getElementById('results').style.display = 'block';
        }

        function exportarCSV() {
            if (!generador.reporteActual) {
                alert('Primero genera un reporte');
                return;
            }

            const headers = ['Nombre', 'Número Cuenta', 'Fecha', 'Día', 'Estado', 'Horario Oficial', 'Entrada Real', 'Salida Real', 'Tardanza (min)', 'Tipo Bloque', 'Observaciones'];
            
            const csvContent = [
                headers.join(','),
                ...generador.reporteActual.map(item => [
                    item.nombreAsesor,
                    item.numeroCuenta,
                    item.fecha,
                    item.dia,
                    item.estado,
                    `${item.horarioOficial.inicio}-${item.horarioOficial.fin}`,
                    item.asistenciaReal?.entrada || 'N/A',
                    item.asistenciaReal?.salida || 'N/A',
                    item.tiempoTardanza,
                    item.tipoBloque,
                    `"${item.observaciones.join('; ')}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `reporte_asistencia_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportarPDF() {
            alert('Función de exportación a PDF en desarrollo');
        }

        // Establecer fechas por defecto
        document.addEventListener('DOMContentLoaded', function() {
            const hoy = new Date();
            const haceUnaSemana = new Date();
            haceUnaSemana.setDate(hoy.getDate() - 7);
            
            document.getElementById('fechaInicio').value = haceUnaSemana.toISOString().split('T')[0];
            document.getElementById('fechaFin').value = hoy.toISOString().split('T')[0];
        });
    </script>
</body>
</html>